<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coffee Hour</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }
    #box {
      background: white;
      max-width: 500px;
      margin: auto;
      padding: 15px;
      border-radius: 8px;
    }
    input, button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
    }
    li {
      margin: 6px 0;
    }
    .username {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="box">
  <h1>â˜• Coffee Hour</h1>

  <!-- Username input -->
  <div id="usernameView">
    <input id="usernameInput" placeholder="Choose a username">
    <button id="saveUsername">Save Username</button>
  </div>

  <!-- Forum -->
  <div id="forumView" style="display:none;">
    <input id="messageInput" placeholder="Write a message">
    <button id="postMessage">Post</button>
    <ul id="messages"></ul>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
  // --- Supabase setup ---
  const supabaseClient = supabase.createClient(
    "https://pzmxsohkznheycizvwsk.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6bXhzb2hrem5oZXljaXp2d3NrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MzQ3OTcsImV4cCI6MjA4MzExMDc5N30.unssQUmvp8J-2GyETuWX9xh83fhebAN9IUPsTCTe7d0"
  );

  // --- Username management ---
  let username = localStorage.getItem("coffeeHourUsername") || "";
  const usernameView = document.getElementById("usernameView");
  const forumView = document.getElementById("forumView");
  const saveBtn = document.getElementById("saveUsername");
  const postBtn = document.getElementById("postMessage");

  // If user already has a username, skip the input
  if (username) {
    usernameView.style.display = "none";
    forumView.style.display = "block";
  }

  // Save username
  saveBtn.onclick = () => {
    const value = document.getElementById("usernameInput").value.trim();
    if (!value) return;

    username = value;
    localStorage.setItem("coffeeHourUsername", username);
    usernameView.style.display = "none";
    forumView.style.display = "block";
  };

  // Post message
  postBtn.onclick = async () => {
    const text = document.getElementById("messageInput").value.trim();
    if (!text || !username) return;

    // --- Load banned users ---
    const bannedUsers = JSON.parse(localStorage.getItem("bannedUsers") || "{}");
    const now = Date.now();

    // Check if current user is banned
    if (bannedUsers[username] && bannedUsers[username] > now) {
      alert("You are banned and cannot post messages right now.");
      return;
    }

    // --- Check for ban command ---
    if (username === "The Barista" && text.startsWith("/ban ")) {
      const parts = text.split(" ");
      if (parts.length === 3) {
        const bannedUser = parts[1];
        const hours = parseFloat(parts[2]);
        if (!isNaN(hours)) {
          bannedUsers[bannedUser] = now + hours * 60 * 60 * 1000;
          localStorage.setItem("bannedUsers", JSON.stringify(bannedUsers));
          alert(`${bannedUser} is banned for ${hours} hour(s).`);
          document.getElementById("messageInput").value = "";
          return;
        }
      }
    }

    // --- Normal message insert ---
    await supabaseClient.from("posts").insert({
      username: username,
      message: text
    });

    document.getElementById("messageInput").value = "";
    loadMessages();
  };

  // Load messages with colors and hide banned users
  async function loadMessages() {
    const { data, error } = await supabaseClient
      .from("posts")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Error loading messages:", error);
      return;
    }

    const list = document.getElementById("messages");
    list.innerHTML = "";

    if (!data) return;

    const bannedUsers = JSON.parse(localStorage.getItem("bannedUsers") || "{}");
    const now = Date.now();

    data.forEach(row => {
      // Skip banned users
      if (bannedUsers[row.username] && bannedUsers[row.username] > now) return;

      const li = document.createElement("li");
      const color = row.username === username ? "#00aaff" : "black";

      li.innerHTML = `<span class="username" style="color:${color}">${row.username}:</span> ${row.message}`;
      list.appendChild(li);
    });
  }

  // Auto-refresh every 2 seconds
  setInterval(loadMessages, 2000);
  loadMessages();
</script>

</body>
</html>
